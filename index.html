<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube视频在线解析下载</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-active {
            color: #3b82f6;
            border-bottom: 2px solid #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #f9f9f9;
            min-width: 120px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            z-index: 1;
            border-radius: 4px;
            margin-top: 2px;
        }
        .dropdown.active .dropdown-content {
            display: block;
        }
        .dropdown-item {
            padding: 12px 16px;
            display: block;
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }
        .dropdown-item:hover {
            background-color: #f1f1f1;
        }
    </style>
</head>
<body class="bg-white text-gray-800 min-h-screen">
    <!-- 导航栏 -->
    <nav class="bg-gray-900 text-white py-3 px-6">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-6">
                <a href="#" class="font-bold text-xl" data-i18n="title">YouTube下载器</a>
            </div>
            <div class="flex items-center space-x-4">
                <div class="dropdown" id="languageDropdown">
                    <button class="px-4 py-2 hover:bg-gray-800 rounded" onclick="toggleDropdown('languageDropdown')">Language</button>
                    <div class="dropdown-content">
                        <a class="dropdown-item" onclick="changeLanguage('zh-CN')">简体中文</a>
                        <a class="dropdown-item" onclick="changeLanguage('zh-TW')">繁體中文</a>
                        <a class="dropdown-item" onclick="changeLanguage('en')">English</a>
                    </div>
                </div>
                <div class="dropdown" id="userDropdown">
                    <button class="px-4 py-2 hover:bg-gray-800 rounded" onclick="toggleDropdown('userDropdown')" id="userMenuButton">
                        <span id="userDisplayName">个人中心</span>
                    </button>
                    <div class="dropdown-content">
                        <a href="#" class="dropdown-item" onclick="openSettings()">设置</a>
                        <a href="#" class="dropdown-item" onclick="logoutUser()">退出登录</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8">
        <h1 class="text-4xl font-bold text-center mb-8" data-i18n="mainTitle">YouTube视频在线解析下载</h1>
        
        <div id="loginMessage" class="max-w-3xl mx-auto mb-8 bg-yellow-100 p-4 rounded-lg text-yellow-800 hidden">
            请先<a href="login.html" class="text-blue-600 hover:underline">登录</a>后使用下载功能
        </div>

        <div class="max-w-3xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden border">
            <div class="p-6">
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        id="urlInput"
                        class="flex-1 px-4 py-3 bg-white border border-gray-300 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="输入YouTube分享地址"
                    >
                    <button 
                        onclick="analyzeVideoDirectly()"
                        class="px-8 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium transition-colors text-white"
                    >
                        解析
                    </button>
                </div>
            </div>

            <div id="result" class="hidden">
                <div class="flex border-b">
                    <button class="tab-button flex-1 py-3 px-4 text-center" data-tab="video" onclick="showContentTab('video')">视频</button>
                    <button class="tab-button flex-1 py-3 px-4 text-center" data-tab="image" onclick="showContentTab('image')">图片</button>
                    <button class="tab-button flex-1 py-3 px-4 text-center" data-tab="text" onclick="showContentTab('text')">文本</button>
                </div>
                <div id="videoInfo" class="p-6">
                    <!-- 这里将显示视频信息 -->
                </div>
            </div>
        </div>

        <div class="max-w-3xl mx-auto mt-8 bg-white p-6 rounded-lg shadow-lg border">
            <h2 class="text-xl font-semibold mb-4" data-i18n="howToTitle">如何解析下载视频？</h2>
            <ol class="list-decimal list-inside space-y-2 text-gray-600">
                <li data-i18n="step1">在Youtube里面复制分享链接，例如 https://www.youtube.com/watch?v=UTKS3UKUCUs/</li>
                <li data-i18n="step2">在本网站输入Youtube分享链接</li>
                <li data-i18n="step3">点击"解析"按钮获取视频下载链接</li>
            </ol>
            <div class="mt-4 p-4 bg-gray-50 rounded-lg text-sm text-gray-600">
                <p data-i18n="disclaimer">声明：本站为用户提供各大视频地址在线解析服务，我们不储存、不发布视频、视频版权归属其合法持有人所有，本站不提供任何资源存储服务。解析方法来源网络，如有侵权，请联系461545764@qq.com。</p>
            </div>
        </div>
    </main>

    <script>
    // 语言配置
    const i18n = {
        'zh-CN': {
            title: 'YouTube下载器',
            mainTitle: 'YouTube视频在线解析下载',
            userCenter: '个人中心',
            login: '登录',
            register: '注册',
            settings: '设置',
            inputPlaceholder: '输入YouTube分享地址',
            analyze: '解析',
            howToTitle: '如何解析下载视频？',
            step1: '在Youtube里面复制分享链接，例如 https://www.youtube.com/watch?v=UTKS3UKUCUs/',
            step2: '在本网站输入Youtube分享链接',
            step3: '点击"解析"按钮获取视频下载链接',
            disclaimer: '声明：本站为用户提供各大视频地址在线解析服务，我们不储存、不发布视频、视频版权归属其合法持有人所有，本站不提供任何资源存储服务。解析方法来源网络，如有侵权，请联系461545764@qq.com。',
            logout: '退出登录',
            loginRequired: '请先登录后使用下载功能'
        },
        'zh-TW': {
            title: 'YouTube下載器',
            mainTitle: 'YouTube視頻在線解析下載',
            userCenter: '個人中心',
            login: '登錄',
            register: '註冊',
            settings: '設置',
            inputPlaceholder: '輸入YouTube分享地址',
            analyze: '解析',
            howToTitle: '如何解析下載視頻？',
            step1: '在Youtube裡面復制分享鏈接，例如 https://www.youtube.com/watch?v=UTKS3UKUCUs/',
            step2: '在本網站輸入Youtube分享鏈接',
            step3: '點擊"解析"按鈕獲取視頻下載鏈接',
            disclaimer: '聲明：本站為用戶提供各大視頻地址在線解析服務，我們不儲存、不發布視頻、視頻版權歸屬其合法持有人所有，本站不提供任何資源存儲服務。解析方法來源網絡，如有侵權，請聯繫461545764@qq.com。',
            logout: '退出登錄',
            loginRequired: '請先登錄後使用下載功能'
        },
        'en': {
            title: 'YouTube Downloader',
            mainTitle: 'YouTube Video Online Parser & Downloader',
            userCenter: 'User Center',
            login: 'Login',
            register: 'Register',
            settings: 'Settings',
            inputPlaceholder: 'Enter YouTube share link',
            analyze: 'Parse',
            howToTitle: 'How to Download Videos?',
            step1: 'Copy the share link from Youtube, e.g. https://www.youtube.com/watch?v=UTKS3UKUCUs/',
            step2: 'Enter the Youtube share link on this website',
            step3: 'Click the "Parse" button to get video download links',
            disclaimer: 'Disclaimer: This website provides online video parsing services for users. We do not store or publish videos. All video copyrights belong to their legal owners. We do not provide any resource storage services. If there are any copyright issues, please contact 461545764@qq.com.',
            logout: 'Logout',
            loginRequired: 'Please login to use the download feature'
        }
    };

    // 更改语言函数
    function changeLanguage(lang) {
        // 更新页面上所有带有 data-i18n 属性的元素
        document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');
            if (i18n[lang][key]) {
                element.textContent = i18n[lang][key];
            }
        });

        // 更新输入框的 placeholder
        document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
            const key = element.getAttribute('data-i18n-placeholder');
            if (i18n[lang][key]) {
                element.placeholder = i18n[lang][key];
            }
        });

        // 保存语言选择到 localStorage
        localStorage.setItem('preferred-language', lang);
    }

    // 检查登录状态并更新UI
    function updateAuthUI() {
        const token = localStorage.getItem('auth_token');
        const username = localStorage.getItem('username');
        const loggedOutMenu = document.getElementById('loggedOutMenu');
        const loggedInMenu = document.getElementById('loggedInMenu');
        const loginMessage = document.getElementById('loginMessage');
        const userDisplayName = document.getElementById('userDisplayName');
        const urlInput = document.getElementById('urlInput');
        const analyzeButton = document.querySelector('button[onclick="analyzeVideoDirectly()"]');

        if (token && username) {
            loggedOutMenu.style.display = 'none';
            loggedInMenu.style.display = 'block';
            loginMessage.style.display = 'none';
            userDisplayName.textContent = username;
            if (urlInput) urlInput.disabled = false;
            if (analyzeButton) analyzeButton.disabled = false;
        } else {
            loggedOutMenu.style.display = 'block';
            loggedInMenu.style.display = 'none';
            loginMessage.style.display = 'block';
            userDisplayName.textContent = '个人中心';
            if (urlInput) urlInput.disabled = true;
            if (analyzeButton) analyzeButton.disabled = true;
        }
    }

    // 页面加载时检查登录状态
    document.addEventListener('DOMContentLoaded', () => {
        updateAuthUI();
        const savedLang = localStorage.getItem('preferred-language');
        if (savedLang) {
            changeLanguage(savedLang);
        }
    });

    // 切换下拉菜单
    function toggleDropdown(id) {
        var dropdown = document.getElementById(id);
        if (dropdown.classList.contains('active')) {
            dropdown.classList.remove('active');
        } else {
            // 关闭其他下拉菜单
            var dropdowns = document.getElementsByClassName('dropdown');
            for (var i = 0; i < dropdowns.length; i++) {
                dropdowns[i].classList.remove('active');
            }
            dropdown.classList.add('active');
        }
    }

    // 点击页面其他地方关闭下拉菜单
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.dropdown')) {
            var dropdowns = document.getElementsByClassName('dropdown');
            for (var i = 0; i < dropdowns.length; i++) {
                dropdowns[i].classList.remove('active');
            }
        }
    });

    // 设置功能
    function openSettings() {
        alert('设置功能尚未实现');
    }

    // 退出登录
    function logoutUser() {
        localStorage.removeItem('auth_token');
        localStorage.removeItem('username');
        alert('已成功退出登录');
        window.location.href = 'login.html';
    }

    // 页面加载时更新用户信息
    document.addEventListener('DOMContentLoaded', function() {
        // 获取用户信息
        var username = localStorage.getItem('username');
        if (username) {
            document.getElementById('userDisplayName').textContent = username;
        }
    });

    // 直接解析视频
    async function analyzeVideoDirectly() {
        // 获取登录状态
        const token = localStorage.getItem('auth_token');
        const username = localStorage.getItem('username');
        
        if (!token || !username) {
            alert('请先登录后使用');
            window.location.href = 'login.html';
            return;
        }
        
        const urlInput = document.getElementById('urlInput');
        const resultDiv = document.getElementById('result');
        const videoInfoDiv = document.getElementById('videoInfo');
        const url = urlInput.value.trim();
        
        if (!url) {
            alert('请输入YouTube URL');
            return;
        }
        
        // 显示加载状态
        resultDiv.classList.remove('hidden');
        videoInfoDiv.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div><p class="mt-4 text-gray-600">视频解析中，请稍候...</p></div>';
        
        // 默认激活视频标签
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('tab-active');
        });
        document.querySelector('.tab-button[data-tab="video"]').classList.add('tab-active');
        
        try {
            // 发送请求到API端点
            const response = await fetch(`/api/download?url=${encodeURIComponent(url)}&action=analyze`, {
              method: 'GET',
              headers: {
                'Authorization': `Bearer ${token}`
              }
            });
            
            if (!response.ok) {
                throw new Error(`服务器响应错误: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('解析结果:', data);
            
            // 保存解析数据到全局变量
            window.parsedData = data;
            
            // 显示视频标签内容
            showContentTab('video');
        } catch (error) {
            console.error('解析错误:', error);
            videoInfoDiv.innerHTML = `<div class="text-center py-8 text-red-500"><p>解析失败: ${error.message}</p></div>`;
        }
    }

    // 显示不同标签的内容
    function showContentTab(tab) {
        if (!window.parsedData) {
            console.log("没有解析数据");
            return;
        }
        
        console.log("当前标签:", tab, "数据:", window.parsedData);
        
        // 移除所有标签的活跃状态
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('tab-active');
        });
        
        // 添加当前标签的活跃状态
        document.querySelector(`.tab-button[data-tab="${tab}"]`).classList.add('tab-active');
        
        const videoInfoEl = document.getElementById('videoInfo');
        videoInfoEl.innerHTML = '';
        
        if (tab === 'video') {
            // 视频标签内容
            const videoFormats = window.parsedData.formats.video || [];
            const audioFormats = window.parsedData.formats.audio || [];
            
            if (videoFormats.length > 0 || audioFormats.length > 0) {
                // 视频下载选项
                if (videoFormats.length > 0) {
                    const videoTitle = document.createElement('h3');
                    videoTitle.className = 'font-semibold text-lg mb-2';
                    videoTitle.textContent = '视频下载选项';
                    videoInfoEl.appendChild(videoTitle);
                    
                    videoFormats.forEach(format => {
                        const formatSize = format.size ? `${Math.round(format.size / 1024 / 1024)}MB` : '未知大小';
                        const qualityText = format.quality || '标准质量';
                        
                        const downloadDiv = document.createElement('div');
                        downloadDiv.className = 'mb-2 p-2 border border-gray-200 rounded hover:bg-gray-50 flex justify-between items-center';
                        
                        const qualitySpan = document.createElement('span');
                        qualitySpan.textContent = `${qualityText} - ${formatSize}`;
                        downloadDiv.appendChild(qualitySpan);
                        
                        const downloadBtn = document.createElement('a');
                        downloadBtn.className = 'px-4 py-1 bg-blue-500 text-white rounded hover:bg-blue-600';
                        downloadBtn.textContent = '下载';
                        downloadBtn.href = format.url;
                        downloadBtn.setAttribute('target', '_blank');
                        
                        downloadDiv.appendChild(downloadBtn);
                        videoInfoEl.appendChild(downloadDiv);
                    });
                }
                
                // 音频下载选项
                if (audioFormats.length > 0) {
                    const audioTitle = document.createElement('h3');
                    audioTitle.className = 'font-semibold text-lg mb-2 mt-4';
                    audioTitle.textContent = '音频下载选项';
                    videoInfoEl.appendChild(audioTitle);
                    
                    audioFormats.forEach(format => {
                        const formatSize = format.size ? `${Math.round(format.size / 1024 / 1024)}MB` : '未知大小';
                        
                        const downloadDiv = document.createElement('div');
                        downloadDiv.className = 'mb-2 p-2 border border-gray-200 rounded hover:bg-gray-50 flex justify-between items-center';
                        
                        const qualitySpan = document.createElement('span');
                        qualitySpan.textContent = `音频 - ${formatSize}`;
                        downloadDiv.appendChild(qualitySpan);
                        
                        const downloadBtn = document.createElement('a');
                        downloadBtn.className = 'px-4 py-1 bg-blue-500 text-white rounded hover:bg-blue-600';
                        downloadBtn.textContent = '下载';
                        downloadBtn.href = format.url;
                        downloadBtn.setAttribute('target', '_blank');
                        
                        downloadDiv.appendChild(downloadBtn);
                        videoInfoEl.appendChild(downloadDiv);
                    });
                }
            } else {
                videoInfoEl.innerHTML = '<p class="text-center text-gray-500 py-4">没有可用的下载选项</p>';
            }
        } else if (tab === 'image') {
            // 图片标签内容
            if (window.parsedData.thumbnail) {
                const img = document.createElement('img');
                img.src = window.parsedData.thumbnail;
                img.className = 'max-w-full h-auto mx-auto';
                img.alt = window.parsedData.title || 'Video Thumbnail';
                
                const downloadDiv = document.createElement('div');
                downloadDiv.className = 'text-center mt-4';
                
                const downloadBtn = document.createElement('a');
                downloadBtn.className = 'px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 inline-block';
                downloadBtn.textContent = '下载缩略图';
                downloadBtn.href = window.parsedData.thumbnail;
                downloadBtn.setAttribute('download', '');
                downloadBtn.setAttribute('target', '_blank');
                
                downloadDiv.appendChild(downloadBtn);
                
                videoInfoEl.appendChild(img);
                videoInfoEl.appendChild(downloadDiv);
            } else {
                videoInfoEl.innerHTML = '<p class="text-center text-gray-500 py-4">暂无图片</p>';
            }
        } else if (tab === 'text') {
            // 文本标签内容
            const titleEl = document.createElement('h2');
            titleEl.className = 'text-xl font-bold mb-4';
            titleEl.textContent = window.parsedData.title || '无标题';
            
            const descEl = document.createElement('p');
            descEl.className = 'text-gray-700 whitespace-pre-line';
            descEl.textContent = window.parsedData.description || '无描述';
            
            videoInfoEl.appendChild(titleEl);
            videoInfoEl.appendChild(descEl);
        }
    }
    
    // 添加视频下载函数
    function downloadVideo(url, filename) {
        // 显示下载进度
        const progressDiv = document.createElement('div');
        progressDiv.className = 'fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-50';
        progressDiv.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full">
                <h3 class="text-lg font-semibold mb-4">正在下载: ${filename}</h3>
                <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                    <div id="download-progress-bar" class="bg-blue-600 h-4 rounded-full" style="width: 0%"></div>
                </div>
                <p id="download-progress-text" class="text-center">准备下载...</p>
                <button id="cancel-download" class="mt-4 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 w-full">取消</button>
            </div>
        `;
        document.body.appendChild(progressDiv);
        
        const progressBar = document.getElementById('download-progress-bar');
        const progressText = document.getElementById('download-progress-text');
        const cancelButton = document.getElementById('cancel-download');
        
        let abortController = new AbortController();
        let signal = abortController.signal;
        
        cancelButton.addEventListener('click', () => {
            abortController.abort();
            document.body.removeChild(progressDiv);
        });
        
        // 开始下载
        fetch(url, { signal })
            .then(response => {
                if (!response.ok) throw new Error(`下载失败: ${response.status} ${response.statusText}`);
                
                const contentLength = response.headers.get('content-length');
                const total = contentLength ? parseInt(contentLength, 10) : 0;
                let loaded = 0;
                
                const reader = response.body.getReader();
                const chunks = [];
                
                return new Promise((resolve, reject) => {
                    function pump() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                                resolve(new Blob(chunks));
                                return;
                            }
                            
                            chunks.push(value);
                            loaded += value.length;
                            
                            if (total) {
                                const percent = Math.round((loaded / total) * 100);
                                progressBar.style.width = `${percent}%`;
                                progressText.textContent = `${percent}% (${(loaded / 1024 / 1024).toFixed(1)}MB / ${(total / 1024 / 1024).toFixed(1)}MB)`;
                            } else {
                                progressText.textContent = `已下载 ${(loaded / 1024 / 1024).toFixed(1)}MB`;
                            }
                            
                            pump();
                        }).catch(reject);
                    }
                    
                    pump();
                });
            })
            .then(blob => {
                // 创建下载链接并点击
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                
                // 清理
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    document.body.removeChild(progressDiv);
                }, 100);
            })
            .catch(error => {
                if (error.name === 'AbortError') {
                    console.log('下载已取消');
                } else {
                    alert(`下载失败: ${error.message}`);
                    console.error('下载错误:', error);
                }
                try {
                    document.body.removeChild(progressDiv);
                } catch (e) {}
            });
    }
    </script>
    <script src="auth.js"></script>
    <script src="app.js"></script>
</body>
</html>